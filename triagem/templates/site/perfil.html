{% extends 'site/headerBase.html' %}
{% load static %}

{% block title %}Meu Perfil - MedTriagem{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'front/css/perfil.css' %}?v=3">
{% endblock %}

{% block content %}

{% with usuario=perfil_usuario|default:user %}

<div class="profile-main-container">

    <a href="javascript:history.back()" class="btn-voltar">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 12H5"></path><polyline points="12 19 5 12 12 5"></polyline></svg>
            <span>Voltar</span>
        
    </a>

    <h2>Perfil de Usu√°rio</h2>

    <div class="profile-content-wrapper">
        <aside class="profile-sidebar">
            <div class="profile-card">

                <div class="avatar-upload-container">
                    {# 1. Verifica√ß√£o se existe foto_perfil. Se existir, usa a URL da foto. #}
                    {% if usuario.foto_perfil %}
                        <img src="{{ usuario.foto_perfil.url }}" alt="Foto de Perfil de {{ usuario.nome_completo }}" id="profile-pic-display">
                    {# 2. Se n√£o existir, usa uma imagem padr√£o (placeholder). #}
                    {% else %}
                        <img src="{% static 'front/img/avatar_default.png' %}" alt="Avatar Padr√£o" id="profile-pic-display">
                    {% endif %}
                    

                    {% if usuario == user %}
                    <div class="avatar-overlay">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="feather feather-camera"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
                        <span>Editar</span>
                    </div>
                    {% endif %}

                    {% if usuario == user %}
                    <form id="avatar-upload-form" method="post" enctype="multipart/form-data" style="display: none;">
                        {% csrf_token %}
                        {{ form_foto.foto_perfil }} </form>
                    {% endif %}
                </div>

                {% if perfil_usuario.foto_perfil %}
                <form method="POST" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" 
                            name="btn_remover_foto" 
                            class="btn btn-danger btn-sm position-absolute top-0 end-0 rounded-circle"
                            style="right: -10px;"
                            title="Remover foto atual"
                            onclick="return confirm('Tem certeza que deseja remover sua foto?');">
                        <i class="fas fa-trash"></i>
                    </button>
                </form>
                {% endif %}

                <h3>Dr. {{ usuario.nome_completo }}</h3>
                <p class="username">@{{ usuario.username }}</p>

                {% comment %} 
                    L√≥gica corrigida para mostrar o status ou o tipo de conta, mas n√£o os dois.
                {% endcomment %}
                {% if not usuario.is_active %}
                    <span class="user-role" style="background-color: #e74c3c; color: white;">Conta fora do sistema</span>
                {% else %}
                    <span class="user-role">{{ usuario.get_tipo_usuario_display }}</span>
                {% endif %}

                {% if usuario == user and usuario.foto_perfil.name != 'fotos_perfil/default.jpg' %}
                    <button type="button" id="clear-photo-ajax-btn" class="btn-clear-photo-ajax" data-url="{% url 'hosp:clear_profile_picture_ajax' %}">
                        Remover Foto
                    </button>
                {% endif %}



                <ul class="profile-details">
                    <li>
                        <span class="icon">üë§</span>
                        <div>
                            <small>Nome Completo</small>
                            <p>{{ usuario.nome_completo }}</p>
                        </div>
                    </li>
                    <li>
                        <span class="icon">üìß</span>
                        <div>
                            <small>Email</small>
                            <p>{{ usuario.email }}</p>
                        </div>
                    </li>
                    <li>
                        <span class="icon">üí≥</span>
                        <div>
                            <small>CPF</small>
                            <p>{{ usuario.cpf }}</p>
                        </div>
                    </li>
                    <!--<li>
                        <span class="icon">üè∑Ô∏è</span>
                        <div>
                            <small>Tipo de Conta</small>
                            <p>{{ usuario.get_tipo_usuario_display }}</p>
                        </div>
                    </li>-->
                    {% if usuario.tipo_usuario == 'MEDICO' or usuario.tipo_usuario == 'ENFERMEIRO' %}
                    <li>
                        <span class="icon">üìú</span>
                        <div>
                            <small>Registro Profissional</small>
                            <p>{{ usuario.registro_formatado }}</p>
                        </div>
                    </li>
                    {% endif %}
                    <li>
                        <span class="icon">üìÖ</span>
                        <div>
                            <small>Criado em</small>
                            <p>{{ usuario.date_joined|date:"d/m/Y" }}</p>
                        </div>
                    </li>
                </ul>

                {% if user.is_superuser or user.tipo_usuario == 'ADMIN' and usuario != user %}
                    <hr>
                    
                    {% comment %} Mostra o bot√£o DESATIVAR se o usu√°rio estiver ATIVO {% endcomment %}
                    {% if usuario.is_active %}
                        <form action="{% url 'hosp:desativar_usuario' pk=usuario.pk %}" method="post" onsubmit="return confirm('Tem certeza que deseja desativar a conta de \'{{ usuario.nome_completo|addslashes }}\'? Ele(a) n√£o poder√° mais fazer login.');">
                            {% csrf_token %}
                            <button type="submit" class="logout-btn" style="background-color: #f39c12;">
                                <span class="icon">üö´</span> Desativar Conta
                            </button>
                        </form>

                    {% comment %} Mostra o bot√£o REATIVAR se o usu√°rio estiver INATIVO {% endcomment %}
                    {% else %}
                        <form action="{% url 'hosp:reativar_usuario' pk=usuario.pk %}" method="post" onsubmit="return confirm('Tem certeza que deseja reativar a conta de \'{{ usuario.nome_completo|addslashes }}\'? Ele(a) poder√° fazer login novamente.');">
                            {% csrf_token %}
                            <button type="submit" class="logout-btn" style="background-color: #2ecc71;">
                                <span class="icon">‚úÖ</span> Reativar Conta
                            </button>
                        </form>
                    {% endif %}

                {% endif %}

                {% if usuario == user %}
                <form action="{% url 'hosp:logout' %}" method="post" onsubmit="return confirm('Tem certeza que deseja sair da sua conta?');">
                    {% csrf_token %}
                    <button type="submit" class="logout-btn">
                        <span class="icon">‚Üí</span> Sair (Logout)
                    </button>
                </form>

                <hr>
                <div class="d-grid gap-2">
                    <a href="{% url 'hosp:alterar_senha' %}" class="btn btn-outline-danger">
                        <i class="fas fa-key"></i> Redefinir Minha Senha
                    </a>
                </div>
                {% endif %}
            </div>
        </aside>

        <section class="profile-main-content">
            <div class="tabs-container">
                <button class="tab-button active" data-tab="historico">Hist√≥rico de Pacientes</button>
                <button class="tab-button" data-tab="feedbacks">Meus Feedbacks</button>
            </div>

            <div id="historico" class="tab-content active">
                <div class="content-card">
                    <h4>Pacientes Atendidos</h4>
                    <p>Hist√≥rico dos pacientes que voc√™ atendeu ou acompanhou</p>
                    <table>
                        <thead>
                            <tr>
                                <th>Nome do Paciente</th>
                                <th>Data de Chegada</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for paciente in page_obj_historico %}
                            <tr>
                                <td><a href="{% url 'hosp:mostrar' pk=paciente.pk %}">{{ paciente.nome }}</a></td>
                                <td>üóìÔ∏è {{ paciente.hora_chegada|date:"d/m/Y" }}</td>
                                <td><span class="status-tag {{ paciente.status|slugify }}">{{ paciente.get_status_display }}</span></td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3">Nenhum paciente no hist√≥rico.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            {% if page_obj_historico and page_obj_historico.paginator.num_pages > 1 %}
                <div class="pagination" style="margin-top: 20px; text-align: center;">
                    <span class="step-links">
                        {% if page_obj_historico.has_previous %}
                            <a href="?page=1">&laquo; primeira</a>
                            <a href="?page={{ page_obj_historico.previous_page_number }}">anterior</a>
                        {% endif %}

                        <span class="current">
                            P√°gina {{ page_obj_historico.number }} de {{ page_obj_historico.paginator.num_pages }}.
                        </span>

                        {% if page_obj_historico.has_next %}
                            <a href="?page={{ page_obj_historico.next_page_number }}">pr√≥xima</a>
                            <a href="?page={{ page_obj_historico.paginator.num_pages }}">√∫ltima &raquo;</a>
                        {% endif %}
                    </span>
                </div>
            {% endif %}

            <div id="feedbacks" class="tab-content">
                <div class="content-card">
                    <h4>Meus Feedbacks</h4>
                    <p>Avalia√ß√µes que voc√™ fez sobre as classifica√ß√µes de triagem</p>
                    <table>
                        <thead>
                            <tr>
                                <th>Paciente</th>
                                <th>Classifica√ß√£o Original</th>
                                <th>Minha Avalia√ß√£o</th>
                                <th>Data</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for feedback in page_obj_feedbacks %}
                            <tr>
                                <td><a href="{% url 'hosp:mostrar' pk=feedback.paciente.pk %}">{{ feedback.paciente.nome }}</a></td>
                                <td><span class="tag {{ feedback.paciente.classificacao|slugify }}">{{ feedback.paciente.get_classificacao_display }}</span></td>

                                <td>
                                    {% if feedback.triagem_correta %}
                                        <span class="avaliacao correta">‚úîÔ∏è Correta</span>
                                    {% else %}
                                        <div class="avaliacao-wrapper">
                                            <span class="avaliacao incorreta">‚ùå Incorreta</span>
                                            <small>Sugest√£o: {{ feedback.get_classificacao_correta_display }}</small>
                                        </div>
                                    {% endif %}    
                                </td>
                                <td>üóìÔ∏è {{ feedback.data_criacao|date:"d/m/Y" }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4">Nenhum feedback enviado.</td>
                            </tr>
                            {% endfor %}
                        </tbody>

                        {# ADICIONADO: Controles de Pagina√ß√£o para os Feedbacks #}
                        {% if page_obj_feedbacks and page_obj_feedbacks.paginator.num_pages > 1 %}
                            <div class="pagination" style="margin-top: 20px; text-align: center;">
                                <span class="step-links">
                                    {% if page_obj_feedbacks.has_previous %}
                                        {# Os links usam ?fpage=... #}
                                        <a href="?fpage=1">&laquo; primeira</a>
                                        <a href="?fpage={{ page_obj_feedbacks.previous_page_number }}">anterior</a>
                                    {% endif %}

                                    <span class="current">
                                        P√°gina {{ page_obj_feedbacks.number }} de {{ page_obj_feedbacks.paginator.num_pages }}.
                                    </span>

                                    {% if page_obj_feedbacks.has_next %}
                                        {# Os links usam ?fpage=... #}
                                        <a href="?fpage={{ page_obj_feedbacks.next_page_number }}">pr√≥xima</a>
                                        <a href="?fpage={{ page_obj_feedbacks.paginator.num_pages }}">√∫ltima &raquo;</a>
                                    {% endif %}
                                </span>
                            </div>
                        {% endif %}
                    </table>
                </div>
            </div>
        </section>
    </div>
    <div class="container">
    
    <div class="card mb-4">
        <div class="card-header">Meus Dados</div>
        <div class="card-body">
            <form method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                {{ form_dados.as_p }}
                
                <button type="submit" name="btn_dados_pessoais" class="btn btn-primary">
                    Salvar Dados
                </button>
            </form>
        </div>
    </div>

    <div class="card border-danger">
        <div class="card-header bg-danger text-white">Seguran√ßa</div>
        <div class="card-body">
            <form method="POST">
                {% csrf_token %}
                {{ form_senha.as_p }}
                
                <button type="submit" name="btn_mudar_senha" class="btn btn-danger">
                    Atualizar Senha
                </button>
            </form>
        </div>
    </div>

</div>
</div>
{% endwith %}

{% endblock %}

{% block scripts %}
    <script src="{% static 'front/js/perfil.js' %}?v=4"></script>
{% endblock %}




</body>
</html>